<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <meta property="og:title" content="Arrival of a Train at La Ciotat" />
    <meta
      property="og:description"
      content="L'arrivée d'un train en gare de La Ciotat is an 1895 French short black-and-white silent documentary film directed and produced by Auguste and Louis Lumière. Its first public showing took place in January 1896."
    />
    <meta property="og:site_name" content="Open Graph protocol examples" />
    <meta property="og:type" content="video.movie" />
    <meta property="og:locale" content="en_US" />
  </head>
  <body>
    <div id="meta-tags"></div>
    <script type="module">
      ;(async function () {
        try {
          const res = await fetch('http://localhost:8010/proxy') //url needs to be proxied since it might throw cors error
          if (res.status === 200) {
            let html = ''
            const reader = res.body.getReader()
            new ReadableStream({
              start(controller) {
                pump()
                function pump() {
                  reader.read().then(({ done, value }) => {
                    html += new TextDecoder().decode(value)
                    if (done) {
                      parse(html)
                      controller.close()
                    } else {
                      controller.enqueue(value)
                      return pump()
                    }
                  })
                }
              },
            })
          }
        } catch (_) {
          console.log('---', _)
        }

        function parse(html) {
          console.log('parsing')
          if (html == null) {
            return
          }
          try {
            const doc = new DOMParser().parseFromString(html, 'text/html')
            const elements = doc.querySelectorAll('meta[property]')
            const result = []

            for (const el of elements) {
              result.push({
                property: el.getAttribute('property'),
                content: el.content,
              })
            }
            console.log(result)
            if (result.length > 0) {
              document.querySelector("div[id='meta-tags']").innerHTML = `<pre>
                    ${JSON.stringify(result, null, 2)}
                </pre>`
            }
          } catch (error) {
            console.log('--error--', error)
          }
        }
      })()
    </script>
  </body>
</html>
